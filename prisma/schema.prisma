// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// Modelo para páginas de vendas
model SalesPage {
  id            String   @id @default(uuid())
  userId        String
  title         String
  slug          String   @unique
  description   String?
  thumbnail     String?
  layout        Json     @default("[]") // Dados do Craft.js
  published     Boolean  @default(false)
  viewCount     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relações
  sections      PageSection[]
  customDomain  CustomDomain?
  analytics     PageAnalytics[]

  @@index([userId])
  @@index([slug])
}

// Modelo para seções da página
model PageSection {
  id            String   @id @default(uuid())
  pageId        String
  page          SalesPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  type          String   // 'hero', 'text', 'image', 'cta', 'form', etc
  order         Int
  props         Json     // Propriedades do componente
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([pageId])
}

// Modelo para domínios customizados
model CustomDomain {
  id            String   @id @default(uuid())
  pageId        String   @unique
  page          SalesPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  domain        String   @unique
  verified      Boolean  @default(false)
  dnsRecord     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([pageId])
  @@index([domain])
}

// Modelo para analytics
model PageAnalytics {
  id            String   @id @default(uuid())
  pageId        String
  page          SalesPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  date          DateTime @default(now())
  views         Int      @default(0)
  clicks        Int      @default(0)
  createdAt     DateTime @default(now())

  @@index([pageId])
  @@index([date])
}

// Modelo para fluxos (flows/funnels)
model Flow {
  id            String   @id @default(uuid())
  userId        String
  funnelId      String
  name          String
  description   String?
  flowData      Json     @default("{}")
  nodesData     Json     @default("{\"nodes\": [], \"edges\": []}") // Dados do ReactFlow
  published     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, funnelId])
  @@index([userId])
  @@index([funnelId])
}

model TeamMessage {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  username   String
  avatarUrl  String?  @map("avatar_url")
  content    String
  insertedAt DateTime @default(now()) @map("inserted_at")

  @@map("team_messages")
  @@index([userId])
  @@index([insertedAt])
}

// Modelo para integrações globais (ex: Kirvano, etc)
model Integration {
  id            String   @id @default(uuid())
  userId        String?  // Nullable - integrações globais não têm userId
  isGlobal      Boolean  @default(true) // Indica se a integração é global
  name          String   // Nome da integração (ex: "Kirvano")
  provider      String   // Identificador do provider (ex: "kirvano")
  webhookToken  String   @unique @default(uuid()) // Token único para o webhook
  enabled       Boolean  @default(true)
  config        Json     @default("{}") // Configurações adicionais
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relação com eventos recebidos
  events        WebhookEvent[]

  @@index([userId])
  @@index([webhookToken])
  @@index([provider])
}

// Modelo para eventos de webhook recebidos
model WebhookEvent {
  id            String   @id @default(uuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  event         String   // Tipo do evento (ex: "SALE_APPROVED", "ABANDONED_CART")
  payload       Json     // Payload completo do webhook
  processedAt   DateTime @default(now())
  status        String   @default("received") // received, processed, error
  
  @@index([integrationId])
  @@index([event])
  @@index([processedAt])
}

// Modelo para vendas (dados da Kirvano)
model Sale {
  id              String   @id @default(uuid())
  integrationId   String
  
  // Dados da venda
  externalId      String   // sale_id da Kirvano
  checkoutId      String?
  event           String   // Evento que gerou o registro
  status          String   // PENDING, APPROVED, REFUSED, REFUNDED, CHARGEBACK, CANCELED
  paymentMethod   String   // CREDIT_CARD, PIX, BANK_SLIP
  totalPrice      String   // Preço total formatado
  totalPriceCents Int?     // Preço em centavos para cálculos
  type            String   // ONE_TIME, RECURRING
  
  // Dados do cliente
  customerName    String
  customerEmail   String
  customerPhone   String?
  customerDocument String?
  
  // Dados do pagamento
  paymentBrand    String?  // visa, mastercard, etc
  installments    Int?
  finishedAt      DateTime?
  
  // Dados de assinatura (se aplicável)
  planName        String?
  chargeFrequency String?
  nextChargeDate  DateTime?
  
  // Produtos
  products        Json     @default("[]")
  
  // UTMs
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([integrationId, externalId])
  @@index([integrationId])
  @@index([status])
  @@index([customerEmail])
  @@index([createdAt])
}

// Modelo para grupos de leads
model LeadGroup {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String
  name        String
  description String?
  color       String   @default("#6366f1")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relação com leads
  leads       Lead[]

  @@index([userId])
}

// Modelo para leads
model Lead {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String
  groupId      String    @db.Uuid
  group        LeadGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  name         String
  email        String
  phone        String?
  source       String    @default("form")
  status       String    @default("new")
  score        Int       @default(0)
  customFields Json      @default("{}")
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([groupId])
  @@index([email])
  @@index([status])
  @@index([createdAt])
}

// Modelo para automações de email
model Automation {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String
  name         String
  type         String    @default("email") // Tipo: email (por enquanto só email)
  subject      String    // Assunto do email
  message      String    // Conteúdo do email (HTML)
  enabled      Boolean   @default(true)
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([enabled])
}

// Modelo para stages do pipeline de vendas
model PipelineStage {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String
  title         String
  color         String   @default("bg-blue-500")
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relação com oportunidades
  opportunities PipelineOpportunity[]

  @@index([userId])
  @@index([order])
}

// Modelo para oportunidades do pipeline
model PipelineOpportunity {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String
  stageId       String    @db.Uuid
  stage         PipelineStage @relation(fields: [stageId], references: [id], onDelete: Cascade)
  
  title         String
  company       String?
  email         String?
  phone         String?
  value         Decimal   @default(0) @db.Decimal(15, 2)
  order         Int       @default(0)
  notes         String?
  leadId        String?   @db.Uuid
  closedAt      DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([stageId])
  @@index([order])
  @@index([createdAt])
}

// Modelo para sessões de chat de atendimento
model ChatSession {
  id            String    @id @default(uuid()) @db.Uuid
  
  // Dados do visitante
  visitorName   String
  visitorEmail  String?
  visitorPhone  String?
  quizAnswers   Json      @default("{}") // Respostas do quiz
  
  // Atendimento
  attendantId   String?   @db.Uuid // ID do atendente (usuário do sistema)
  status        String    @default("waiting") // waiting, in_progress, completed, abandoned
  queuePosition Int       @default(0)
  
  // Timestamps
  startedAt     DateTime  @default(now())
  attendedAt    DateTime? // Quando foi atendido
  completedAt   DateTime?
  
  // Feedback
  rating        Int?      // 1-5 estrelas
  feedbackText  String?
  feedbackAt    DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relações
  messages      ChatMessage[]

  @@index([status])
  @@index([attendantId])
  @@index([queuePosition])
  @@index([createdAt])
}

// Modelo para mensagens do chat
model ChatMessage {
  id            String    @id @default(uuid()) @db.Uuid
  sessionId     String    @db.Uuid
  session       ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  sender        String    // 'visitor' ou 'attendant'
  senderId      String?   @db.Uuid // ID do atendente se for do sistema
  content       String
  
  createdAt     DateTime  @default(now())

  @@index([sessionId])
  @@index([createdAt])
}
